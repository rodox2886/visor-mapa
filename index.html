
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detector de Luminarias</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    canvas { max-width: 90%; }
    #output { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Detector de Luminarias</h1>
  <input type="file" accept="image/*" onchange="handleImage(event)">
  <br><br>
  <canvas id="canvas"></canvas>
  <div id="output"></div>

  <script>
    let model;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    async function loadModel() {
      model = await tf.loadGraphModel('model/model.json');
      console.log("Modelo cargado");
    }

    async function handleImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = async () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const input = tf.browser.fromPixels(canvas).resizeBilinear([416, 416]).expandDims(0).toFloat().div(255);
        const predictions = await model.executeAsync(input);

        const boxes = predictions[1].arraySync()[0];
        const scores = predictions[4].arraySync()[0];
        const classes = predictions[2].arraySync()[0];

        let count = {};

        for (let i = 0; i < scores.length; i++) {
          if (scores[i] > 0.5) {
            const [ymin, xmin, ymax, xmax] = boxes[i];
            const x = xmin * img.width;
            const y = ymin * img.height;
            const width = (xmax - xmin) * img.width;
            const height = (ymax - ymin) * img.height;

            const label = classes[i];
            count[label] = (count[label] || 0) + 1;

            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            ctx.fillStyle = 'red';
            ctx.fillText(label, x, y > 10 ? y - 5 : y + 15);
          }
        }

        document.getElementById("output").innerText = "Conteo por tipo: " + JSON.stringify(count);
      };

      img.src = URL.createObjectURL(file);
    }

    loadModel();
  </script>
</body>
</html>
